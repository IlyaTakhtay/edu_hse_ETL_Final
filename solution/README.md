# Учебный ETL Проект с Apache Airflow, PostgreSQL и MongoDB

## Описание проекта

Этот проект представляет собой учебный ETL-процесс для репликации данных из MongoDB в PostgreSQL с использованием Apache Airflow.

---

## Технологии

- **Apache Airflow** – отвечает за выполнение ETL-пайплайнов. Каждый DAG в Airflow реализует процесс извлечения, трансформации и загрузки данных.
- **MongoDB** – источник данных, в котором хранятся сырые пользовательские данные.
- **PostgreSQL** – хранилище обработанных данных. В него загружаются очищенные, нормализованные и подготовленные для аналитики данные.
- **Генератор данных** – отдельный сервис, который заполняет MongoDB сгенерированными данными, имитируя реальные.
- **Docker** – используется для развертывания всех сервисов.

---

## Данные, генерируемые скриптом

### 1. **user_sessions** – Информация о сессиях пользователей

- `session_id` – уникальный идентификатор сессии.
- `user_id` – идентификатор пользователя.
- `start_time` – время начала сессии.
- `end_time` – время завершения сессии.
- `pages_visited` – список посещенных страниц.
- `device` – информация об устройстве пользователя.
- `actions` – список действий пользователя.


### 2. **product_price_history** – История изменения цен на товары

- `product_id` – идентификатор товара.
- `price_changes` – список изменений цен (дата и цена).
- `current_price` – текущая цена товара.
- `currency` – валюта цены.


### 3. **event_logs** – Логи событий пользователей

- `event_id` – уникальный идентификатор события.
- `timestamp` – временная метка события.
- `event_type` – тип события (например, вход, выход, ошибка, клик).
- `details` – дополнительная информация о событии.


### 4. **support_tickets** – Обращения пользователей в поддержку

- `ticket_id` – уникальный идентификатор тикета.
- `user_id` – идентификатор пользователя.
- `status` – статус тикета (открыт, закрыт, в ожидании).
- `issue_type` – тип проблемы (ошибка, запрос на новую функцию и т. д.).
- `messages` – список сообщений в тикете.
- `created_at` – дата создания тикета.
- `updated_at` – дата последнего обновления тикета.


### 5. **user_recommendations** – Рекомендации товаров пользователям

- `user_id` – идентификатор пользователя.
- `recommended_products` – список рекомендованных товаров.
- `last_updated` – время последнего обновления рекомендаций.


### 6. **moderation_queue** – Очередь на модерацию отзывов

Данные содержат информацию о пользовательских отзывах, которые проходят модерацию:

- **`review_id`**: Уникальный идентификатор отзыва.
- **`user_id`**: Идентификатор пользователя, оставившего отзыв.
- **`product_id`**: Идентификатор продукта, к которому относится отзыв.
- **`review_text`**: Текст отзыва.
- **`rating`**: Оценка товара (например, от 1 до 5).
- **`moderation_status`**: Статус модерации отзыва (например, "на проверке", "одобрен", "отклонен").
- **`flags`**: Список флагов (например, "спам", "содержит личную информацию").
- **`submitted_at`**: Дата и время отправки отзыва.


### 7. **search_queries** – Поисковые запросы пользователей

- `query_id` – уникальный идентификатор запроса.
- `user_id` – идентификатор пользователя.
- `query_text` – текст запроса.
- `timestamp` – время выполнения запроса.
- `filters` – список примененных фильтров.
- `results_count` – количество результатов запроса.

---

## Данные, реплицируемые из MongoDB в PostgreSQL

### 1. **moderation_queue**

Данные из очереди на модерацию отзывов:

- Используются для построения аналитического датамарта по продуктам.


### 2. **user_sessions**

Информация о взаимодействиях пользователей с системой:

- Используются для анализа поведения пользователей и построения рекомендаций.

---

## Датамарт для отзывов

На основе данных из таблицы `moderation_queue`, создается датамарт `etl.review_mart`, который агрегирует ключевые метрики по продуктам.

### Поля датамарта:

1. **product_id**:
    - Уникальный идентификатор продукта.
2. **total_reviews**:
    - Общее количество отзывов для продукта.
3. **avg_rating**:
    - Средний рейтинг продукта.
4. **approved_reviews_ratio**:
    - Доля одобренных отзывов (отношение количества одобренных отзывов к общему количеству).
5. **total_flags**:
    - Суммарное количество флагов для всех отзывов продукта.
6. **last_updated (Timestamp)**:
    - Временная метка последнего обновления записи в датамарте.

---

## Пример использования датамарта

1. Анализ качества продуктов через средний рейтинг (`avg_rating`) и количество отзывов (`total_reviews`).
2. Выявление проблемных продуктов с большим количеством флагов (`total_flags`) или низкой долей одобренных отзывов (`approved_reviews_ratio`).
3. Отслеживание активности пользователей через временные метки (`last_updated`, `submitted_at`) и анализ трендов.

---

## Как запустить процесс

1. Убедитесь, что все переменные окружения настроены в `.env`.
2. Выполните команды для подготовки инфраструктуры:

```bash
make rebuild
make datgen
make migrate
```

3. Запустите DAG-и в Airflow для выполнения ETL-процесса:
    - DAG для репликации данных из MongoDB в PostgreSQL.
    - DAG для создания датамарта на основе таблицы `moderation_queue`.
